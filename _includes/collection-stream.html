{%- comment -%} Stream all items from the chosen collection, current language {%- endcomment -%}
{%- assign coll = site[page.collection_name] | where: "lang", site.active_lang -%}

{%- comment -%} Split to avoid mixed-type comparisons {%- endcomment -%}
{%- assign with_weight    = coll | where_exp: "d", "d.weight != nil" -%}
{%- assign without_weight = coll | where_exp: "d", "d.weight == nil" -%}

{%- comment -%} If some weights are accidentally strings, this still works as long as theyâ€™re consistent.
    The _config default above makes them numeric. {%- endcomment -%}
{%- assign with_weight = with_weight | sort: "weight" -%}

{%- comment -%} Put items w/o weight after, alphabetically {%- endcomment -%}
{%- assign without_weight = without_weight | sort_natural: "title" -%}

{%- assign coll_sorted = with_weight | concat: without_weight -%}

<div id="stream">
  {%- for doc in coll_sorted -%}
  <article class="stream-card"
           data-cats="{{ doc.categories | join: ' ' }}"
           data-tags="{{ doc.tags | join: ' ' }}">
    <h2 class="stream-title">{{ doc.title }}</h2>
    <h2>{{ doc.title }} (weight={{ doc.weight }})</h2>

    <div class="stream-meta">
      {%- assign has_cats = doc.categories | size | gt: 0 -%}
      {%- assign has_tags = doc.tags       | size | gt: 0 -%}

      {%- if has_cats -%}
        <span class="taxonomy-label">Categories:</span>
        <ul class="taxonomy-list">
          {%- for c in doc.categories -%}
            <li class="taxonomy-item" data-filter="cat" data-key="{{ c | slugify }}">{{ c }}</li>
          {%- endfor -%}
        </ul>
      {%- endif -%}

      {%- if has_cats and has_tags -%}
        <span class="taxonomy-sep" aria-hidden="true">|</span>
      {%- endif -%}

      {%- if has_tags -%}
        <span class="taxonomy-label">Tags:</span>
        <ul class="taxonomy-list">
          {%- for t in doc.tags -%}
            <li class="taxonomy-item" data-filter="tag" data-key="{{ t | slugify }}">{{ t }}</li>
          {%- endfor -%}
        </ul>
      {%- endif -%}
    </div>

    <div class="stream-body">
      {{ doc.content }}
    </div>

    <hr class="stream-divider"/>
  </article>
  {%- endfor -%}
</div>